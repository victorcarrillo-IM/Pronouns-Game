<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;</p>
<p class="p1">&lt;html lang="en"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta charset="UTF-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;title&gt;Pikachu's Pronoun Adventure&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdn.tailwindcss.com"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&amp;display=swap" rel="stylesheet"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>body {</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-family: 'Press Start 2P', cursive;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #1a202c;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-image: radial-gradient(circle, #2d3748 1px, transparent 1px);</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-size: 20px 20px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: #e2e8f0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>overflow: hidden;</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex;</p>
<p class="p1"><span class="Apple-converted-space">            </span>align-items: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>justify-content: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>min-height: 100vh;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>canvas {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #2d3748;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 0.5rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 4px solid #4a5568;</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 0 20px rgba(0,0,0,0.5);</p>
<p class="p1"><span class="Apple-converted-space">            </span>image-rendering: pixelated;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.game-container {</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex;</p>
<p class="p1"><span class="Apple-converted-space">            </span>flex-direction: column;</p>
<p class="p1"><span class="Apple-converted-space">            </span>align-items: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>gap: 1rem;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.ui-panel {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #252e3d;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 4px solid #636e82;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 1rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 0.5rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>min-width: 512px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>text-align: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 4px 15px rgba(0,0,0,0.4);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.quiz-modal {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: fixed;</p>
<p class="p1"><span class="Apple-converted-space">            </span>top: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>left: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 100%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>height: 100%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: rgba(0, 0, 0, 0.7);</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex;</p>
<p class="p1"><span class="Apple-converted-space">            </span>align-items: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>justify-content: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>z-index: 100;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.quiz-content {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #2d3748;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 4px solid;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-image-slice: 1;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-image-source: linear-gradient(to right top, #a0aec0, #cbd5e0);</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 2rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 1rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 90%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>max-width: 600px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>text-align: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 0 25px rgba(255, 255, 255, 0.2);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.quiz-question {</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-size: 1.25rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>margin-bottom: 1.5rem;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.quiz-options button {</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: block;</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 100%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 1rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>margin-bottom: 0.75rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 0.5rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #4a5568;</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: #e2e8f0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-family: 'Press Start 2P', cursive;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 2px solid #718096;</p>
<p class="p1"><span class="Apple-converted-space">            </span>transition: all 0.2s ease-in-out;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.quiz-options button:hover {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #718096;</p>
<p class="p1"><span class="Apple-converted-space">            </span>transform: translateY(-2px);</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 4px 8px rgba(0,0,0,0.3);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.message-box {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: fixed;</p>
<p class="p1"><span class="Apple-converted-space">            </span>bottom: 20px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>left: 50%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>transform: translateX(-50%);</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: rgba(45, 55, 72, 0.9);</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: white;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 1rem 2rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 0.5rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 2px solid #a0aec0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>z-index: 101;</p>
<p class="p1"><span class="Apple-converted-space">            </span>opacity: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>transition: opacity 0.5s;</p>
<p class="p1"><span class="Apple-converted-space">            </span>pointer-events: none;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.health-hearts {</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex;</p>
<p class="p1"><span class="Apple-converted-space">            </span>gap: 0.5rem;</p>
<p class="p1"><span class="Apple-converted-space">            </span>align-items: center;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.heart-container {</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 24px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>height: 24px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: relative;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.heart {</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 24px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>height: 24px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute;</p>
<p class="p1"><span class="Apple-converted-space">            </span>top: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>left: 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>#xp-bar {</p>
<p class="p1"><span class="Apple-converted-space">             </span>background-image: linear-gradient(to right, #22c55e, #4ade80);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="game-container"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;h1 class="text-3xl mb-2 text-yellow-300"&gt;Pikachu's Pronoun Adventure&lt;/h1&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="ui-panel" class="ui-panel text-sm md:text-base"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-between items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div&gt;LVL: &lt;span id="level"&gt;1&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div&gt;&lt;span id="evolution-name"&gt;Pichu&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div&gt;XP: &lt;span id="xp"&gt;0&lt;/span&gt; / &lt;span id="next-level-xp"&gt;100&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="w-full bg-gray-600 rounded-full h-4 mt-2 border-2 border-gray-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="xp-bar" class="h-full rounded-full" style="width: 0%"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="flex items-center gap-2 mt-3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;span class="text-red-400"&gt;HP:&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="health-hearts" class="health-hearts"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;canvas id="gameCanvas" width="512" height="384"&gt;&lt;/canvas&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="text-center text-xs mt-2 text-gray-400"&gt;Find the Key to unlock the doors!&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="quiz-modal" class="quiz-modal hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="quiz-content"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;p id="quiz-question" class="quiz-question"&gt;Question text goes here.&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="quiz-options" class="quiz-options"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;!-- Buttons will be generated by JS --&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="message-box" class="message-box"&gt;&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const canvas = document.getElementById('gameCanvas');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const ctx = canvas.getContext('2d');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- UI ELEMENTS ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>const levelUI = document.getElementById('level');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const xpUI = document.getElementById('xp');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const nextLevelXpUI = document.getElementById('next-level-xp');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const xpBarUI = document.getElementById('xp-bar');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const evolutionNameUI = document.getElementById('evolution-name');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const healthHeartsUI = document.getElementById('health-hearts');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const quizModal = document.getElementById('quiz-modal');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const quizQuestionUI = document.getElementById('quiz-question');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const quizOptionsUI = document.getElementById('quiz-options');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const messageBox = document.getElementById('message-box');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const TILE_SIZE = 32;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const MAP_COLS = canvas.width / TILE_SIZE;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const MAP_ROWS = canvas.height / TILE_SIZE;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- GAME STATE ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>const gameState = {</p>
<p class="p1"><span class="Apple-converted-space">            </span>player: { x: 2, y: 2, prevX: 2, prevY: 2, level: 1, xp: 0, evolution: 0, hp: 6, maxHp: 6, },</p>
<p class="p1"><span class="Apple-converted-space">            </span>currentLevelNumber: 1, currentLevelData: {}, enemies: [],</p>
<p class="p1"><span class="Apple-converted-space">            </span>questionIndex: 0,</p>
<p class="p1"><span class="Apple-converted-space">            </span>playerMoveCount: 0,</p>
<p class="p1"><span class="Apple-converted-space">            </span>key: { x: -1, y: -1, collected: false },</p>
<p class="p1"><span class="Apple-converted-space">            </span>heart: { x: -1, y: -1, active: false },</p>
<p class="p1"><span class="Apple-converted-space">            </span>bossState: 'inactive',<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>pillars: [],<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>projectiles: [],</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p1"><span class="Apple-converted-space">        </span>let currentEncounter = { enemy: null, index: -1, isBossFight: false };</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const evolutions = [</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ name: "Pichu",<span class="Apple-converted-space">    </span>color: "#F7D43B", earColor: "#2D3748", cheekColor: "#F56565", scale: 0.9 },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ name: "Pikachu",<span class="Apple-converted-space">  </span>color: "#F7D43B", earColor: "#2D3748", cheekColor: "#F56565", scale: 1.0 },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ name: "Raichu", <span class="Apple-converted-space">  </span>color: "#F08030", earColor: "#4C3B29", cheekColor: "#F7D43B", scale: 1.1 },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ name: "A-Raichu", color: "#A9855A", earColor: "#4C3B29", cheekColor: "#63B3ED", scale: 1.1 }</p>
<p class="p1"><span class="Apple-converted-space">        </span>];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- BIOME AND LEVEL GENERATION DATA ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>const biomes = ['forest', 'mountain', 'lava', 'arctic', 'ocean'];</p>
<p class="p1"><span class="Apple-converted-space">        </span>const biomeData = {</p>
<p class="p1"><span class="Apple-converted-space">            </span>'forest': <span class="Apple-converted-space">  </span>{ tiles: { 0: "#5D914D", 1: "#4A5568", 2: "#48BB78", 3: "#663300", 4: "#3A3F4B", 5: "#1A202C" }, enemies: ['serpent', 'gassy'] },</p>
<p class="p1"><span class="Apple-converted-space">            </span>'mountain': { tiles: { 0: "#A0AEC0", 1: "#4A5568", 2: "#718096", 3: "#8B4513", 4: "#3A3F4B", 5: "#1A202C" }, enemies: ['rocky', 'serpent'] },</p>
<p class="p1"><span class="Apple-converted-space">            </span>'lava': <span class="Apple-converted-space">    </span>{ tiles: { 0: "#2D3748", 1: "#4A5568", 2: "#E53E3E", 3: "#E53E3E", 4: "#3A3F4B", 5: "#1A202C" }, enemies: ['gassy', 'rocky'] },</p>
<p class="p1"><span class="Apple-converted-space">            </span>'arctic': <span class="Apple-converted-space">  </span>{ tiles: { 0: "#EDF2F7", 1: "#A0AEC0", 2: "#BEE3F8", 3: "#EDF2F7", 4: "#3A3F4B", 5: "#1A202C" }, enemies: ['icy', 'rocky'] },</p>
<p class="p1"><span class="Apple-converted-space">            </span>'ocean':<span class="Apple-converted-space">    </span>{ tiles: { 0: "#3182CE", 1: "#2C7A7B", 2: "#63B3ED", 3: "#3182CE", 4: "#3A3F4B", 5: "#1A202C" }, enemies: ['watery', 'pincer'] }</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p1"><span class="Apple-converted-space">        </span>const HAZARD_TILE_ID = 2; const DOOR_TILE_ID = 3; const LOCKED_DOOR_TILE_ID = 4; const PIT_TILE_ID = 5;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const questions = [</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Shared questions</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "I ___ a creature.", options: ["am", "is", "are"], correct: "am" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "You ___ a trainer.", options: ["am", "is", "are"], correct: "are" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "He ___ strong.", options: ["am", "is", "are"], correct: "is" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "She ___ fast.", options: ["am", "is", "are"], correct: "is" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "___ is my friend.", options: ["She", "Her", "Hers"], correct: "She" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "It ___ a sunny day.", options: ["am", "is", "are"], correct: "is" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "We ___ a team.", options: ["am", "is", "are"], correct: "are" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "They ___ ready.", options: ["am", "is", "are"], correct: "are" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "Give the ball to ___.", options: ["he", "him", "his"], correct: "him" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "The teacher helped ___.", options: ["we", "us", "our"], correct: "us" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "___ are playing outside.", options: ["They", "Them", "Theirs"], correct: "They" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "Is this ___ book?", options: ["you", "your", "yours"], correct: "your" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "That is ___ house.", options: ["our", "ours", "us"], correct: "our" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "The blue bike is ___.", options: ["my", "me", "mine"], correct: "mine" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "___ are my shoes.", options: ["This", "These", "That"], correct: "These" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "Could you pass me ___ book over there?", options: ["this", "that", "those"], correct: "that" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "The decision is ___.", options: ["their", "theirs", "them"], correct: "theirs" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "The cat licked ___ paw.", options: ["it's", "its", "it"], correct: "its" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "He built the shelf ___.", options: ["him", "hisself", "himself"], correct: "himself" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "She bought ___ a new dress.", options: ["her", "herself", "she"], correct: "herself" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "We should do it ___.", options: ["ourselves", "us", "ourself"], correct: "ourselves" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "My friends and ___ went to the movies.", options: ["me", "I", "myself"], correct: "I" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "Between you and ___, this is a secret.", options: ["I", "me", "myself"], correct: "me" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "My brother is taller than ___.", options: ["I", "me", "myself"], correct: "I" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "To ___ should I give the letter?", options: ["who", "whom", "whose"], correct: "whom" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "___ is knocking on the door?", options: ["Who", "Whom", "Whose"], correct: "Who" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "A person should always do ___ best.", options: ["his", "their", "there"], correct: "their" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "Each of the students ___ responsible.", options: ["is", "are", "be"], correct: "is" },</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Boss question 1</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "The team celebrated ___ victory.", options: ["its", "it's", "their"], correct: "its", boss: 1 },</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Boss question 2</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "It was ___ who solved the puzzle.", options: ["she", "her", "herself"], correct: "she", boss: 2 },</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Boss question 3</p>
<p class="p1"><span class="Apple-converted-space">            </span>{ text: "Neither the players nor the coach ___ happy.", options: ["was", "were", "is"], correct: "was", boss: 3 }</p>
<p class="p1"><span class="Apple-converted-space">        </span>];</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- DRAWING FUNCTIONS ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>const enemySprites = {</p>
<p class="p1"><span class="Apple-converted-space">            </span>'rocky': (e) =&gt; { const p=e.x*TILE_SIZE,t=e.y*TILE_SIZE;ctx.fillStyle='#A0AEC0';ctx.beginPath();ctx.arc(p+6,t+18,6,0,7);ctx.fill();ctx.beginPath();ctx.arc(p+26,t+18,6,0,7);ctx.fill();ctx.fillStyle='#718096';ctx.beginPath();ctx.arc(p+16,t+16,12,0,7);ctx.fill();ctx.fillStyle='#2D3748';ctx.beginPath();ctx.moveTo(p+10,t+12);ctx.lineTo(p+14,t+16);ctx.lineTo(p+10,t+16);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(p+22,t+12);ctx.lineTo(p+18,t+16);ctx.lineTo(p+22,t+16);ctx.closePath();ctx.fill();ctx.strokeStyle='#2D3748';ctx.lineWidth=2;ctx.beginPath();ctx.arc(p+16,t+20,4,0,3.14);ctx.stroke();},</p>
<p class="p1"><span class="Apple-converted-space">            </span>'gassy': (e) =&gt; { const p=e.x*TILE_SIZE,t=e.y*TILE_SIZE,s=14+Math.sin(Date.now()/250)*2;ctx.fillStyle=`rgba(128,90,213,${.4+Math.sin(Date.now()/200)*.2})`;ctx.beginPath();ctx.arc(p+16,t+16,s,0,7);ctx.fill();ctx.fillStyle='#2D3748';ctx.beginPath();ctx.arc(p+16,t+16,11,0,7);ctx.fill();ctx.fillStyle='#FFF';ctx.beginPath();ctx.moveTo(p+10,t+14);ctx.lineTo(p+16,t+10);ctx.lineTo(p+16,t+18);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(p+22,t+14);ctx.lineTo(p+16,t+10);ctx.lineTo(p+16,t+18);ctx.closePath();ctx.fill();ctx.fillStyle='#000';ctx.fillRect(p+12,t+13,3,3);ctx.fillRect(p+17,t+13,3,3);},</p>
<p class="p1"><span class="Apple-converted-space">            </span>'serpent': (e) =&gt; { const p=e.x*TILE_SIZE,t=e.y*TILE_SIZE,s=Math.sin(Date.now()/300)*2;ctx.fillStyle='#805AD5';ctx.beginPath();ctx.arc(p+16+s,t+24,5,0,7);ctx.fill();ctx.beginPath();ctx.arc(p+16-s,t+18,6,0,7);ctx.fill();ctx.beginPath();ctx.arc(p+16+s,t+12,8,0,7);ctx.fill();ctx.fillStyle='#F7D43B';ctx.beginPath();ctx.ellipse(p+16+s,t+14,6,2,0,0,7);ctx.fill();ctx.fillStyle='#000';ctx.beginPath();ctx.moveTo(p+12+s,t+10);ctx.lineTo(p+16+s,t+12);ctx.lineTo(p+12+s,t+14);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(p+20+s,t+10);ctx.lineTo(p+16+s,t+12);ctx.lineTo(p+20+s,t+14);ctx.closePath();ctx.fill();},</p>
<p class="p1"><span class="Apple-converted-space">            </span>'icy': (e) =&gt; { const p=e.x*TILE_SIZE,t=e.y*TILE_SIZE;ctx.fillStyle='#90CDF4';ctx.beginPath();ctx.moveTo(p+4,t+18);ctx.lineTo(p+28,t+18);ctx.lineTo(p+24,t+28);ctx.lineTo(p+8,t+28);ctx.closePath();ctx.fill();ctx.fillStyle='#EBF8FF';ctx.beginPath();ctx.moveTo(p+16,t+6);ctx.lineTo(p+28,t+18);ctx.lineTo(p+4,t+18);ctx.closePath();ctx.fill();ctx.strokeStyle='#BEE3F8';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(p+16,t+6);ctx.lineTo(p+16,t+18);ctx.stroke();ctx.fillStyle='#F7D43B';ctx.beginPath();ctx.arc(p+12,t+18,3,0,3.14,!0);ctx.fill();ctx.beginPath();ctx.arc(p+20,t+18,3,0,3.14,!0);ctx.fill();},</p>
<p class="p1"><span class="Apple-converted-space">            </span>'watery': (e) =&gt; { const p=e.x*TILE_SIZE,t=e.y*TILE_SIZE,s=Math.sin(Date.now()/350);ctx.fillStyle='#D6BCFA';ctx.beginPath();ctx.moveTo(p+4,t+12);ctx.lineTo(p+8,t+8);ctx.lineTo(p+10,t+14);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(p+28,t+12);ctx.lineTo(p+24,t+8);ctx.lineTo(p+22,t+14);ctx.closePath();ctx.fill();ctx.fillStyle='#63B3ED';ctx.beginPath();ctx.ellipse(p+16,t+20,10,8,0,0,7);ctx.fill();ctx.beginPath();ctx.arc(p+16,t+14,9,0,7);ctx.fill();ctx.fillStyle='#2D3748';ctx.beginPath();ctx.arc(p+13,t+14,1.5,0,7);ctx.fill();ctx.beginPath();ctx.arc(p+19,t+14,1.5,0,7);ctx.fill();ctx.strokeStyle='#2D3748';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(p+14,t+18+s);ctx.lineTo(p+18,t+18-s);ctx.stroke();},</p>
<p class="p1"><span class="Apple-converted-space">            </span>'pincer': (e) =&gt; { const p = e.x * TILE_SIZE, t = e.y * TILE_SIZE, sway = Math.sin(Date.now() / 200) * 2; ctx.fillStyle = '#E53E3E'; ctx.beginPath(); ctx.ellipse(p + 16, t + 20, 10, 8, 0, 0, 7); ctx.fill(); ctx.fillStyle = '#FC8181'; ctx.beginPath(); ctx.arc(p + 16, t + 18, 7, 0, 7); ctx.fill(); ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(p + 13, t + 16, 3, 0, 7); ctx.fill(); ctx.arc(p + 19, t + 16, 3, 0, 7); ctx.fill(); ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(p + 13, t + 16, 1, 0, 7); ctx.fill(); ctx.arc(p + 19, t + 16, 1, 0, 7); ctx.fill(); ctx.strokeStyle = '#E53E3E'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(p + 6, t + 14 + sway); ctx.lineTo(p, t + 10); ctx.stroke(); ctx.beginPath(); ctx.moveTo(p + 26, t + 14 - sway); ctx.lineTo(p + 32, t + 10); ctx.stroke();},</p>
<p class="p1"><span class="Apple-converted-space">            </span>'boss': (e) =&gt; { const isStunned = gameState.bossState.includes('stunned'); const mainColor = isStunned ? '#F7D43B' : '#E2E8F0'; const tailColor = isStunned ? '#F08030' : '#805AD5'; const p=e.x*TILE_SIZE,t=e.y*TILE_SIZE,b=Math.sin(Date.now()/300)*2,y=t+b; ctx.fillStyle="rgba(0,0,0,0.3)"; ctx.beginPath();ctx.ellipse(p+16,t+30,14,5,0,0,7);ctx.fill(); ctx.fillStyle=mainColor; ctx.beginPath();ctx.ellipse(p+16,y+18,8,14,0,0,7);ctx.fill();ctx.beginPath();ctx.moveTo(p+16,y+10);ctx.quadraticCurveTo(p+28,y-4,p+24,y+10);ctx.quadraticCurveTo(p+20,y,p+16,y+10);ctx.fill();ctx.beginPath();ctx.moveTo(p+16,y+10);ctx.quadraticCurveTo(p+4,y-4,p+8,y+10);ctx.quadraticCurveTo(p+12,y,p+16,y+10);ctx.fill(); ctx.fillStyle=tailColor; ctx.beginPath();ctx.ellipse(p+16,y+30,10,4,0,0,7);ctx.fill(); ctx.fillStyle='#C53030';ctx.beginPath();ctx.moveTo(p+12,y+12);ctx.lineTo(p+16,y+16);ctx.lineTo(p+12,y+20);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(p+20,y+12);ctx.lineTo(p+16,y+16);ctx.lineTo(p+20,y+20);ctx.closePath();ctx.fill();},</p>
<p class="p1"><span class="Apple-converted-space">            </span>'minion_bulbasaur': (e) =&gt; { const p=e.x*TILE_SIZE,t=e.y*TILE_SIZE;ctx.fillStyle="#48BB78";ctx.beginPath();ctx.ellipse(p+16,t+20,10,8,0,0,7);ctx.fill();ctx.fillStyle="#2F855A";ctx.beginPath();ctx.moveTo(p+16,t+10);ctx.lineTo(p+10,t+18);ctx.lineTo(p+22,t+18);ctx.closePath();ctx.fill();ctx.fillStyle="#C53030";ctx.beginPath();ctx.arc(p+12,t+20,2,0,7);ctx.fill();ctx.arc(p+20,t+20,2,0,7);ctx.fill();},</p>
<p class="p1"><span class="Apple-converted-space">            </span>'minion_squirtle': (e) =&gt; { const p=e.x*TILE_SIZE,t=e.y*TILE_SIZE;ctx.fillStyle="#63B3ED";ctx.beginPath();ctx.arc(p+16,t+18,9,0,7);ctx.fill();ctx.fillStyle="#F7D43B";ctx.beginPath();ctx.ellipse(p+16,t+24,8,5,0,0,7);ctx.fill();ctx.fillStyle="#2D3748";ctx.beginPath();ctx.arc(p+13,t+16,2,0,7);ctx.fill();ctx.arc(p+19,t+16,2,0,7);ctx.fill();},</p>
<p class="p1"><span class="Apple-converted-space">            </span>'minion_charmander': (e) =&gt; { const p=e.x*TILE_SIZE,t=e.y*TILE_SIZE,f=4+Math.sin(Date.now()/100)*2;ctx.fillStyle="#F08030";ctx.beginPath();ctx.ellipse(p+16,t+20,8,10,0,0,7);ctx.fill();ctx.fillStyle="#F7D43B";ctx.beginPath();ctx.ellipse(p+16,t+26,6,4,0,0,7);ctx.fill();ctx.fillStyle="#E53E3E";ctx.beginPath();ctx.moveTo(p+24,t+24-f);ctx.lineTo(p+22,t+24);ctx.lineTo(p+26,t+24);ctx.closePath();ctx.fill();}</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function generateLevel(levelNum, entryDir) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const biomeName = biomes[(levelNum - 1) % biomes.length];</p>
<p class="p1"><span class="Apple-converted-space">            </span>const data = { map: Array(MAP_ROWS).fill(0).map(() =&gt; Array(MAP_COLS).fill(0)), tiles: biomeData[biomeName].tiles, enemies: [] };</p>
<p class="p1"><span class="Apple-converted-space">            </span>for (let y=0; y&lt;MAP_ROWS; y++) { for (let x=0; x&lt;MAP_COLS; x++) { if (x==0 || x==MAP_COLS-1 || y==0 || y==MAP_ROWS-1) data.map[y][x] = 1; } }</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const midX = Math.floor(MAP_COLS/2), midY = Math.floor(MAP_ROWS/2);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (entryDir !== 'north') data.map[0][midX] = LOCKED_DOOR_TILE_ID;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (entryDir !== 'south') data.map[MAP_ROWS - 1][midX] = LOCKED_DOOR_TILE_ID;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (entryDir !== 'west') data.map[midY][0] = LOCKED_DOOR_TILE_ID;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (entryDir !== 'east') data.map[midY][MAP_COLS - 1] = LOCKED_DOOR_TILE_ID;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>switch(entryDir) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'south': data.startPos = { x: midX, y: MAP_ROWS - 2 }; data.map[MAP_ROWS - 1][midX] = DOOR_TILE_ID; break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'west': data.startPos = { x: 1, y: midY }; data.map[midY][0] = DOOR_TILE_ID; break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'east': data.startPos = { x: MAP_COLS - 2, y: midY }; data.map[midY][MAP_COLS-1] = DOOR_TILE_ID; break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>default: data.startPos = { x: midX, y: 1 }; if(levelNum &gt; 1) data.map[0][midX] = DOOR_TILE_ID; break;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>gameState.heart.active = false;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (levelNum % 5 === 0) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>data.enemies.push({ x: midX, y: midY, type: 'boss' });</p>
<p class="p1"><span class="Apple-converted-space">                </span>gameState.bossState = 'phase1_active'; gameState.pillars = []; gameState.projectiles = [];</p>
<p class="p1"><span class="Apple-converted-space">                </span>const pPos = [{x:3,y:3},{x:MAP_COLS-4,y:3},{x:3,y:MAP_ROWS-4},{x:MAP_COLS-4,y:MAP_ROWS-4}];</p>
<p class="p1"><span class="Apple-converted-space">                </span>pPos.forEach(pos =&gt; { data.map[pos.y][pos.x] = 0; gameState.pillars.push({x: pos.x, y: pos.y, activated: false}); });</p>
<p class="p1"><span class="Apple-converted-space">                </span>gameState.key.collected = true; // No key in boss rooms</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>for(let i=0; i&lt;15+levelNum; i++) { const x=Math.floor(Math.random()*(MAP_COLS-2))+1, y=Math.floor(Math.random()*(MAP_ROWS-2))+1; if(data.map[y][x]===0) { if(Math.random() &lt; 0.3) { data.map[y][x] = 6 + Math.floor(Math.random() * 4); } else { data.map[y][x]=1; } } }</p>
<p class="p1"><span class="Apple-converted-space">                </span>for(let i=0; i&lt;5+levelNum; i++) { const x=Math.floor(Math.random()*(MAP_COLS-2))+1, y=Math.floor(Math.random()*(MAP_ROWS-2))+1; if(data.map[y][x]===0) data.map[y][x]=HAZARD_TILE_ID; }</p>
<p class="p1"><span class="Apple-converted-space">                </span>const types = biomeData[biomeName].enemies; const num = 2 + Math.floor(levelNum/2);</p>
<p class="p1"><span class="Apple-converted-space">                </span>for(let i=0;i&lt;num;i++) { let x, y; do { x=Math.floor(Math.random()*(MAP_COLS-2))+1; y=Math.floor(Math.random()*(MAP_ROWS-2))+1; } while(data.map[y][x]!==0); data.enemies.push({ x, y, type: types[Math.floor(Math.random()*types.length)] }); }</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Place key</p>
<p class="p1"><span class="Apple-converted-space">                </span>gameState.key.collected = false;</p>
<p class="p1"><span class="Apple-converted-space">                </span>let keyX, keyY;</p>
<p class="p1"><span class="Apple-converted-space">                </span>do {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>keyY = (entryDir === 'north' || entryDir === 'west' || entryDir === 'east') ? Math.floor(MAP_ROWS * 0.75) : Math.floor(MAP_ROWS * 0.25);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>keyX = Math.floor(Math.random() * (MAP_COLS - 4)) + 2;</p>
<p class="p1"><span class="Apple-converted-space">                </span>} while (data.map[keyY][keyX] !== 0);</p>
<p class="p1"><span class="Apple-converted-space">                </span>gameState.key.x = keyX; gameState.key.y = keyY;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Place heart every 2 levels</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (levelNum % 2 === 0) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>gameState.heart.active = true;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>let heartX, heartY;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>do {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>heartX = Math.floor(Math.random() * (MAP_COLS - 2)) + 1;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>heartY = Math.floor(Math.random() * (MAP_ROWS - 2)) + 1;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>} while (data.map[heartY][heartX] !== 0 || (heartX === keyX &amp;&amp; heartY === keyY));</p>
<p class="p1"><span class="Apple-converted-space">                    </span>gameState.heart.x = heartX; gameState.heart.y = heartY;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>return data;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function loadLevel(levelNum, entryDir = 'north') {</p>
<p class="p1"><span class="Apple-converted-space">            </span>gameState.currentLevelNumber = levelNum; gameState.playerMoveCount = 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>gameState.currentLevelData = generateLevel(levelNum, entryDir);</p>
<p class="p1"><span class="Apple-converted-space">            </span>gameState.player.x = gameState.currentLevelData.startPos.x; gameState.player.y = gameState.currentLevelData.startPos.y;</p>
<p class="p1"><span class="Apple-converted-space">            </span>gameState.enemies = gameState.currentLevelData.enemies;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(gameState.enemies.length === 0 &amp;&amp; !gameState.bossState.includes('phase')) unlockDoors();</p>
<p class="p1"><span class="Apple-converted-space">            </span>gameLoop();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function drawTileDetails(tileType, tiles, col, row) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const x = col * TILE_SIZE; const y = row * TILE_SIZE;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const floorColor = tiles[0]; const wallColor = tiles[1];</p>
<p class="p1"><span class="Apple-converted-space">            </span>ctx.fillStyle = floorColor; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>let color = tiles[tileType] || floorColor;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>switch(tileType) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 0: break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 1: ctx.fillStyle=wallColor;ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE);ctx.fillStyle="rgba(0,0,0,0.15)";ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE);ctx.strokeStyle="rgba(0,0,0,0.1)";ctx.lineWidth=2;ctx.strokeRect(x+2,y+2,TILE_SIZE-4,TILE_SIZE-4);break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case HAZARD_TILE_ID: ctx.fillStyle=color;ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE);ctx.fillStyle=`rgba(0,0,0,${.1+Math.sin(Date.now()/200+x+y)*.05})`;ctx.beginPath();ctx.arc(x+TILE_SIZE/2,y+TILE_SIZE/2,TILE_SIZE/3,0,7);ctx.fill();break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case DOOR_TILE_ID: case LOCKED_DOOR_TILE_ID: ctx.fillStyle=color;ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE);ctx.fillStyle="rgba(0,0,0,0.2)";ctx.fillRect(x+4,y+4,TILE_SIZE-8,TILE_SIZE-8);break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case PIT_TILE_ID: const grad=ctx.createRadialGradient(x+16,y+16,4,x+16,y+16,16);grad.addColorStop(0,"#000");grad.addColorStop(1,floorColor);ctx.fillStyle=grad;ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE);break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 6: ctx.fillStyle=wallColor;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+TILE_SIZE,y);ctx.lineTo(x,y+TILE_SIZE);ctx.closePath();ctx.fill();break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 7: ctx.fillStyle=wallColor;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+TILE_SIZE,y);ctx.lineTo(x+TILE_SIZE,y+TILE_SIZE);ctx.closePath();ctx.fill();break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 8: ctx.fillStyle=wallColor;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x,y+TILE_SIZE);ctx.lineTo(x+TILE_SIZE,y+TILE_SIZE);ctx.closePath();ctx.fill();break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 9: ctx.fillStyle=wallColor;ctx.beginPath();ctx.moveTo(x+TILE_SIZE,y);ctx.lineTo(x+TILE_SIZE,y+TILE_SIZE);ctx.lineTo(x,y+TILE_SIZE);ctx.closePath();ctx.fill();break;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function drawMap() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const { map, tiles } = gameState.currentLevelData;</p>
<p class="p1"><span class="Apple-converted-space">            </span>for (let r=0;r&lt;MAP_ROWS;r++) { for (let c=0;c&lt;MAP_COLS;c++) { drawTileDetails(map[r][c], tiles, c, r); } }</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function drawPlayer() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const e=evolutions[gameState.player.evolution],p=gameState.player.x*TILE_SIZE,t=gameState.player.y*TILE_SIZE,s=e.scale;ctx.fillStyle="rgba(0,0,0,0.2)";ctx.beginPath();ctx.ellipse(p+16,t+28,10*s,4*s,0,0,7);ctx.fill();ctx.fillStyle=e.earColor;ctx.beginPath();ctx.moveTo(p+10*s,t+6*s);ctx.lineTo(p+4*s,t-8*s);ctx.lineTo(p+16*s,t+2*s);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(p+22*s,t+6*s);ctx.lineTo(p+28*s,t-8*s);ctx.lineTo(p+16*s,t+2*s);ctx.closePath();ctx.fill();ctx.fillStyle=e.color;ctx.beginPath();ctx.ellipse(p+16,t+16,12*s,13*s,0,0,7);ctx.fill();ctx.fillStyle=e.cheekColor;ctx.beginPath();ctx.arc(p+8*s,t+18*s,4*s,0,7);ctx.fill();ctx.beginPath();ctx.arc(p+24*s,t+18*s,4*s,0,7);ctx.fill();ctx.fillStyle='#2D3748';ctx.beginPath();ctx.arc(p+12*s,t+14*s,2*s,0,7);ctx.fill();ctx.beginPath();ctx.arc(p+20*s,t+14*s,2*s,0,7);ctx.fill();ctx.beginPath();ctx.moveTo(p+16,t+16*s);ctx.lineTo(p+14*s,t+18*s);ctx.moveTo(p+16,t+16*s);ctx.lineTo(p+18*s,t+18*s);ctx.lineWidth=s;ctx.strokeStyle='#2D3748';ctx.stroke();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function drawKey() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!gameState.key.collected &amp;&amp; gameState.currentLevelNumber % 5 !== 0) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const kx = gameState.key.x * TILE_SIZE; const ky = gameState.key.y * TILE_SIZE;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const flash = Math.abs(Math.sin(Date.now() / 300));</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.fillStyle = `rgba(252, 211, 77, ${0.6 + flash * 0.4})`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.beginPath(); ctx.arc(kx + 16, ky + 16, 12, 0, 7); ctx.fill();</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.fillStyle = "#FBBF24"; ctx.fillRect(kx + 12, ky + 8, 8, 12);</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.beginPath(); ctx.arc(kx + 16, ky + 10, 5, 0, 7); ctx.fill();</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.fillStyle = "#F59E0B"; ctx.fillRect(kx + 14, ky + 20, 4, 6);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function drawHeart() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (gameState.heart.active) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const hx = gameState.heart.x * TILE_SIZE; const hy = gameState.heart.y * TILE_SIZE;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const flash = Math.abs(Math.sin(Date.now() / 250));</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.fillStyle = `rgba(239, 68, 68, ${0.7 + flash * 0.3})`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.beginPath();</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.moveTo(hx + 16, hy + 10);</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.bezierCurveTo(hx + 16, hy + 6, hx + 10, hy + 8, hx + 10, hy + 14);</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.bezierCurveTo(hx + 10, hy + 20, hx + 16, hy + 22, hx + 16, hy + 26);</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.bezierCurveTo(hx + 16, hy + 22, hx + 22, hy + 20, hx + 22, hy + 14);</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.bezierCurveTo(hx + 22, hy + 8, hx + 16, hy + 6, hx + 16, hy + 10);</p>
<p class="p1"><span class="Apple-converted-space">                </span>ctx.fill();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function drawEnemies() { gameState.enemies.forEach(e =&gt; { enemySprites[e.type](e); if(e.type==='boss' &amp;&amp; (gameState.bossState.includes('active') || gameState.bossState.includes('minions'))) { const x=e.x*TILE_SIZE, y=e.y*TILE_SIZE; ctx.fillStyle=`rgba(128,90,213,${.4+Math.sin(Date.now()/200)*.2})`; ctx.beginPath(); ctx.arc(x+16,y+16,20,0,7);ctx.fill();}}); }</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function drawPillars() { gameState.pillars.forEach(p =&gt; { const x=p.x*TILE_SIZE,y=p.y*TILE_SIZE;ctx.fillStyle='#4A5568';ctx.fillRect(x+8,y+8,16,16);ctx.fillStyle=p.activated?'#F7D43B':'#A0AEC0';ctx.beginPath();ctx.arc(x+16,y+16,6,0,7);ctx.fill();if(p.activated){ctx.fillStyle=`rgba(251,211,141,${.5+Math.sin(Date.now()/150)*.3})`;ctx.beginPath();ctx.arc(x+16,y+16,8,0,7);ctx.fill();}}); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>function drawProjectiles() { gameState.projectiles.forEach(p =&gt; { ctx.fillStyle=`rgba(128,90,213,${.8+Math.sin(Date.now()/100)*.2})`; ctx.beginPath();ctx.arc(p.x*TILE_SIZE+16,p.y*TILE_SIZE+16,6,0,7);ctx.fill();}); }</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>const heartSVGs={empty:'&lt;svg class="heart" viewBox="0 0 24 24" fill="#4a5568"&gt;&lt;path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/&gt;&lt;/svg&gt;',half:'&lt;path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09V21.35z" fill="#ef4444"/&gt;&lt;path d="M12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3c-1.74 0-3.41.81-4.5 2.09V21.35z" fill="#4a5568"/&gt;',full:'&lt;path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="#ef4444"/&gt;'};</p>
<p class="p1"><span class="Apple-converted-space">        </span>function updateUI() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const p=gameState.player,nextXP=p.level*100;levelUI.textContent=p.level;xpUI.textContent=p.xp;nextLevelXpUI.textContent=nextXP;xpBarUI.style.width=`${p.xp/nextXP*100}%`;evolutionNameUI.textContent=evolutions[p.evolution].name;healthHeartsUI.innerHTML='';</p>
<p class="p1"><span class="Apple-converted-space">            </span>for(let i=0;i&lt;p.maxHp/2;i++) { let h=''; const hp=p.hp-i*2; if(hp&gt;=2)h=heartSVGs.full;else if(hp===1)h=heartSVGs.half;else h=heartSVGs.empty; healthHeartsUI.insertAdjacentHTML('beforeend',`&lt;div class="heart-container"&gt;&lt;svg class="heart" viewBox="0 0 24 24"&gt;${h}&lt;/svg&gt;&lt;/div&gt;`); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function showMessage(text, duration=2000) { messageBox.textContent=text;messageBox.style.opacity='1';setTimeout(()=&gt;messageBox.style.opacity='0',duration); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>function handlePlayerDefeat() { showMessage("You fainted!",3000);gameState.player.hp=gameState.player.maxHp;loadLevel(1,'north');updateUI(); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>function addXP(amount) { const p=gameState.player;p.xp+=amount;const nextXP=p.level*100;if(p.xp&gt;=nextXP){p.xp-=nextXP;p.level++;showMessage(`Level Up! You are level ${p.level}!`,3000);checkEvolution();} updateUI(); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>function checkEvolution() { let p=gameState.player,e=!1;if(p.level&gt;=9&amp;&amp;p.evolution&lt;3){p.evolution=3;e=!0}else if(p.level&gt;=6&amp;&amp;p.evolution&lt;2){p.evolution=2;e=!0}else if(p.level&gt;=3&amp;&amp;p.evolution&lt;1){p.evolution=1;e=!0} if(e){setTimeout(()=&gt;showMessage(`What? ${evolutions[p.evolution-1].name} is evolving!`,3000),1e3);setTimeout(()=&gt;{showMessage(`Congratulations! It evolved into ${evolutions[p.evolution].name}!`,4e3);updateUI()},4e3)} }</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function presentQuestion(isBoss, bossPhase) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>let q;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (isBoss) { q = questions.find(qu =&gt; qu.boss === bossPhase); }<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>else { const regularQs = questions.filter(qu =&gt; !qu.boss); q = regularQs[gameState.questionIndex % regularQs.length]; }</p>
<p class="p1"><span class="Apple-converted-space">            </span>quizQuestionUI.textContent = q.text; quizOptionsUI.innerHTML = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>const opts=[...q.options].sort(()=&gt;.5-Math.random());</p>
<p class="p1"><span class="Apple-converted-space">            </span>opts.forEach(opt=&gt;{const btn=document.createElement('button');btn.textContent=opt;btn.onclick=()=&gt;checkAnswer(opt===q.correct,q.correct);quizOptionsUI.appendChild(btn);});</p>
<p class="p1"><span class="Apple-converted-space">            </span>quizModal.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function startEncounter(enemy, index) { currentEncounter={enemy,index,isBossFight:enemy.type.includes('minion')||enemy.type==='boss'}; presentQuestion(currentEncounter.isBossFight, parseInt(gameState.bossState.charAt(5))); }</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function checkAnswer(isCorrect, correctAnswer) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const p=gameState.player;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(!currentEncounter.isBossFight) gameState.questionIndex++;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if(isCorrect) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showMessage(`Correct!`,1500);</p>
<p class="p1"><span class="Apple-converted-space">                </span>if(currentEncounter.isBossFight &amp;&amp; currentEncounter.enemy.type === 'boss') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if(gameState.bossState === 'phase1_stunned') { gameState.bossState='phase2_minions'; showMessage('Mewtwo summons help!',2500); spawnBossMinions(); gameState.pillars.forEach(p=&gt;p.activated=false);}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>else if(gameState.bossState === 'phase2_stunned') {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>gameState.enemies = gameState.enemies.filter(e =&gt; !e.type.includes('minion')); // Clear remaining minions</p>
<p class="p1"><span class="Apple-converted-space">                        </span>gameState.bossState='phase3_active'; showMessage('Mewtwo is enraged!',2500); gameState.pillars.forEach(p=&gt;p.activated=false);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>else if(gameState.bossState === 'phase3_stunned') {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>showMessage("Mewtwo Defeated! +500 XP!",3000); addXP(500); p.maxHp+=2;p.hp=p.maxHp; showMessage("You gained a Heart Container!",2500);<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                        </span>gameState.enemies.splice(currentEncounter.index, 1); gameState.bossState = 'defeated'; unlockDoors();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const xpGained=currentEncounter.isBossFight?100:30+Math.floor(gameState.questionIndex/questions.length)*10;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>addXP(xpGained); gameState.enemies.splice(currentEncounter.index,1);</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                 </span>showMessage(`Incorrect! The answer was: ${correctAnswer}`,2000); p.hp-=2; p.x=p.prevX;p.y=p.prevY; showMessage("You were pushed back!",2000);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>quizModal.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(p.hp&lt;=0) { handlePlayerDefeat(); }</p>
<p class="p1"><span class="Apple-converted-space">            </span>updateUI(); gameLoop();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function unlockDoors() { const m=gameState.currentLevelData.map; for(let y=0;y&lt;MAP_ROWS;y++)for(let x=0;x&lt;MAP_COLS;x++)if(m[y][x]===LOCKED_DOOR_TILE_ID)m[y][x]=DOOR_TILE_ID; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function movePlayer(dx, dy) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(!quizModal.classList.contains('hidden'))return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const p=gameState.player; p.prevX=p.x;p.prevY=p.y;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const newX=p.x+dx,newY=p.y+dy;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const boss = gameState.enemies.find(e=&gt;e.type==='boss');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(boss &amp;&amp; newX === boss.x &amp;&amp; newY === boss.y) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if(gameState.bossState.includes('stunned')) { startEncounter(boss, gameState.enemies.indexOf(boss)); }<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>else if (gameState.bossState.includes('active') || gameState.bossState.includes('minions')) { p.hp -= 3; showMessage("Mewtwo's shield is active! It hurts!", 2000); updateUI(); }</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const enemyIdx=gameState.enemies.findIndex(e=&gt;e.x===newX&amp;&amp;e.y===newY);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(enemyIdx!==-1) { startEncounter(gameState.enemies[enemyIdx],enemyIdx); return; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const map=gameState.currentLevelData.map; const tile=map[newY]?map[newY][newX]:1;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(tile===1 || (tile &gt;= 6 &amp;&amp; tile &lt;= 9) || tile===LOCKED_DOOR_TILE_ID)return;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (tile === PIT_TILE_ID) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>p.hp = 0; showMessage("You fell into a pit!", 2000);</p>
<p class="p1"><span class="Apple-converted-space">                </span>handlePlayerDefeat(); return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>p.x=newX;p.y=newY;</p>
<p class="p1"><span class="Apple-converted-space">            </span>gameState.playerMoveCount++;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (newX === gameState.key.x &amp;&amp; newY === gameState.key.y &amp;&amp; !gameState.key.collected) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>gameState.key.collected = true;</p>
<p class="p1"><span class="Apple-converted-space">                </span>unlockDoors();</p>
<p class="p1"><span class="Apple-converted-space">                </span>showMessage("Key obtained! The doors are unlocked!", 2500);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (gameState.heart.active &amp;&amp; newX === gameState.heart.x &amp;&amp; newY === gameState.heart.y) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>gameState.heart.active = false;</p>
<p class="p1"><span class="Apple-converted-space">                </span>p.hp = Math.min(p.maxHp, p.hp + 2);</p>
<p class="p1"><span class="Apple-converted-space">                </span>showMessage("You recovered a heart!", 1500);</p>
<p class="p1"><span class="Apple-converted-space">                </span>updateUI();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if(tile===HAZARD_TILE_ID){p.hp-=1;showMessage("Ouch! Dangerous terrain!",1000);updateUI();}</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(tile===DOOR_TILE_ID){let dir='n';if(newY===0)dir='s';if(newY===MAP_ROWS-1)dir='n';if(newX===0)dir='e';if(newX===MAP_COLS-1)dir='w';loadLevel(gameState.currentLevelNumber+1,dir);return;}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if(gameState.bossState.includes('phase')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const pillar=gameState.pillars.find(pil=&gt;pil.x===newX&amp;&amp;pil.y===newY);</p>
<p class="p1"><span class="Apple-converted-space">                </span>if(pillar&amp;&amp;!pillar.activated&amp;&amp;(gameState.bossState==='phase1_active'||gameState.bossState==='phase3_active'||gameState.bossState==='phase2_minions')) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>pillar.activated=true;showMessage("Pillar activated!",1500);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if(gameState.pillars.every(pil=&gt;pil.activated)){</p>
<p class="p1"><span class="Apple-converted-space">                         </span>if(gameState.bossState==='phase1_active') gameState.bossState='phase1_stunned';</p>
<p class="p1"><span class="Apple-converted-space">                         </span>else if(gameState.bossState==='phase2_minions') gameState.bossState='phase2_stunned';</p>
<p class="p1"><span class="Apple-converted-space">                         </span>else if(gameState.bossState==='phase3_active') gameState.bossState='phase3_stunned';</p>
<p class="p1"><span class="Apple-converted-space">                         </span>showMessage("Mewtwo is stunned! Its shield is down!",2500); gameState.projectiles=[];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(p.hp&lt;=0){handlePlayerDefeat();return;}</p>
<p class="p1"><span class="Apple-converted-space">            </span>takeEnemyTurns(); gameLoop();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function updateProjectiles() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const p = gameState.player;</p>
<p class="p1"><span class="Apple-converted-space">            </span>for (let i = gameState.projectiles.length - 1; i &gt;= 0; i--) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const proj = gameState.projectiles[i];</p>
<p class="p1"><span class="Apple-converted-space">                </span>proj.x += proj.dx; proj.y += proj.dy;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (proj.x === p.x &amp;&amp; proj.y === p.y) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>p.hp -= 2; showMessage("Hit by a shockwave!", 1500);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>gameState.projectiles.splice(i, 1); updateUI();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (p.hp &lt;= 0) { handlePlayerDefeat(); return true; }</p>
<p class="p1"><span class="Apple-converted-space">                    </span>continue;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>const map = gameState.currentLevelData.map;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (proj.x&lt;0||proj.x&gt;=MAP_COLS||proj.y&lt;0||proj.y&gt;=MAP_ROWS) { gameState.projectiles.splice(i, 1); continue; }</p>
<p class="p1"><span class="Apple-converted-space">                </span>const tile = map[proj.y][proj.x];</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (tile===1||(tile&gt;=6&amp;&amp;tile&lt;=9)||tile===LOCKED_DOOR_TILE_ID) { gameState.projectiles.splice(i, 1); continue; }</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>return false;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function findPath(startX, startY, targetX, targetY) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>let queue = [{x: startX, y: startY, path: []}];</p>
<p class="p1"><span class="Apple-converted-space">            </span>let visited = new Set([`${startX},${startY}`]);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const map = gameState.currentLevelData.map;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>while (queue.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>let { x, y, path } = queue.shift();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (x === targetX &amp;&amp; y === targetY) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>return path[0];</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>const dirs = [[0, -1], [0, 1], [-1, 0], [1, 0]];</p>
<p class="p1"><span class="Apple-converted-space">                </span>for (const [dx, dy] of dirs) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const newX = x + dx;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const newY = y + dy;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (newX &gt;= 0 &amp;&amp; newX &lt; MAP_COLS &amp;&amp; newY &gt;= 0 &amp;&amp; newY &lt; MAP_ROWS &amp;&amp; !visited.has(`${newX},${newY}`)) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const tile = map[newY][newX];</p>
<p class="p1"><span class="Apple-converted-space">                        </span>if (tile === 0 || (newX === targetX &amp;&amp; newY === targetY)) { // Can move on floor or onto target</p>
<p class="p1"><span class="Apple-converted-space">                             </span>visited.add(`${newX},${newY}`);</p>
<p class="p1"><span class="Apple-converted-space">                             </span>const newPath = [...path, {x: newX, y: newY}];</p>
<p class="p1"><span class="Apple-converted-space">                             </span>queue.push({x: newX, y: newY, path: newPath});</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>return null; // No path found</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function takeEnemyTurns() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(updateProjectiles()) return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const p = gameState.player;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(gameState.bossState.includes('phase')) updateBoss();</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>for(let i=gameState.enemies.length-1; i&gt;=0; i--){</p>
<p class="p1"><span class="Apple-converted-space">                </span>const e = gameState.enemies[i];</p>
<p class="p1"><span class="Apple-converted-space">                </span>if(e.type === 'boss') continue;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>const target = p; // Always target the player</p>
<p class="p1"><span class="Apple-converted-space">                </span>const nextStep = findPath(e.x, e.y, target.x, target.y);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (nextStep) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const isOccupied = gameState.enemies.some((other, otherIdx) =&gt; i !== otherIdx &amp;&amp; other.x === nextStep.x &amp;&amp; other.y === nextStep.y);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const isPlayer = p.x === nextStep.x &amp;&amp; p.y === nextStep.y;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (!isOccupied &amp;&amp; !isPlayer) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>e.x = nextStep.x;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>e.y = nextStep.y;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function updateBoss() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const boss=gameState.enemies.find(e=&gt;e.type==='boss'); if(!boss) return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(gameState.bossState==='phase1_active' &amp;&amp; gameState.playerMoveCount &gt; 0 &amp;&amp; gameState.playerMoveCount % 4 === 0){ gameState.projectiles.push({x:boss.x,y:boss.y,dx:0,dy:-1},{x:boss.x,y:boss.y,dx:0,dy:1},{x:boss.x,y:boss.y,dx:-1,dy:0},{x:boss.x,y:boss.y,dx:1,dy:0}); }</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(gameState.bossState==='phase3_active'){</p>
<p class="p1"><span class="Apple-converted-space">                </span>const possibleTiles=[];</p>
<p class="p1"><span class="Apple-converted-space">                </span>const pillarLocs = new Set(gameState.pillars.map(p =&gt; `${p.x},${p.y}`));</p>
<p class="p1"><span class="Apple-converted-space">                </span>for(let y=1;y&lt;MAP_ROWS-1;y++) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>for(let x=1;x&lt;MAP_COLS-1;x++){</p>
<p class="p1"><span class="Apple-converted-space">                        </span>if(gameState.currentLevelData.map[y][x]===0 &amp;&amp; !pillarLocs.has(`${x},${y}`)) {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>possibleTiles.push({x,y});</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>if(possibleTiles.length &gt; 5){</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const tileToDestroy=possibleTiles[Math.floor(Math.random()*possibleTiles.length)];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>gameState.currentLevelData.map[tileToDestroy.y][tileToDestroy.x]=PIT_TILE_ID;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function spawnBossMinions() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const positions=[{x:3,y:5},{x:MAP_COLS-4,y:5},{x:3,y:MAP_ROWS-6}];</p>
<p class="p1"><span class="Apple-converted-space">            </span>const types=['minion_bulbasaur','minion_squirtle','minion_charmander'];</p>
<p class="p1"><span class="Apple-converted-space">            </span>positions.forEach((pos,i)=&gt;{gameState.enemies.push({x:pos.x,y:pos.y,type:types[i]});});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>document.addEventListener('keydown', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>switch(e.key) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'ArrowUp': movePlayer(0,-1); break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'ArrowDown': movePlayer(0,1); break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'ArrowLeft': movePlayer(-1,0); break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'ArrowRight': movePlayer(1,0); break;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function gameLoop() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>ctx.clearRect(0,0,canvas.width,canvas.height);</p>
<p class="p1"><span class="Apple-converted-space">            </span>drawMap();<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>drawKey();</p>
<p class="p1"><span class="Apple-converted-space">            </span>drawHeart();</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(gameState.currentLevelNumber%5===0)drawPillars();</p>
<p class="p1"><span class="Apple-converted-space">            </span>drawEnemies();<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>drawPlayer();</p>
<p class="p1"><span class="Apple-converted-space">            </span>drawProjectiles();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- INITIALIZATION ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>loadLevel(1,'north');</p>
<p class="p1"><span class="Apple-converted-space">        </span>updateUI();</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
<p class="p2"><br></p>
</body>
</html>
